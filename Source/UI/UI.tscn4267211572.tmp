[gd_scene load_steps=33 format=3 uid="uid://d4agehp3labnq"]

[ext_resource type="PackedScene" uid="uid://bfuixbdwhkawx" path="res://Source/UI/OptionsMenu.tscn" id="2_ff03q"]
[ext_resource type="RichTextEffect" uid="uid://dwgdfx0e4jnq0" path="res://Source/Session/Messages/MessageSender.tres" id="2_ywsxj"]
[ext_resource type="RichTextEffect" uid="uid://8mwr7veqf0q2" path="res://Source/Session/Messages/MessageTimestamp.tres" id="3_ywsxj"]
[ext_resource type="PackedScene" uid="uid://7c580cxvugqx" path="res://Source/UI/HotkeyButton.tscn" id="4_agc84"]
[ext_resource type="RichTextEffect" uid="uid://bakqufq0bf6hb" path="res://Source/Session/Messages/MessageType.tres" id="4_eqdp0"]
[ext_resource type="Resource" uid="uid://btppugycedn4k" path="res://Assets/data/commands/PlaceMarker.tres" id="5_ywsxj"]
[ext_resource type="Resource" uid="uid://de63rcnhi843t" path="res://Assets/data/commands/DrawRuler.tres" id="6_eqdp0"]
[ext_resource type="Resource" uid="uid://fxep0u4jcoab" path="res://Assets/data/commands/ToggleMapUI.tres" id="7_agc84"]

[sub_resource type="GDScript" id="GDScript_ywsxj"]
script/source = "extends HSplitContainer


func _ready():
	dragging_enabled = PlayerSettings.resizeable_ui
"

[sub_resource type="GDScript" id="GDScript_f33fr"]
script/source = "extends VSplitContainer


func _ready():
	dragging_enabled = PlayerSettings.resizeable_ui
"

[sub_resource type="LabelSettings" id="LabelSettings_xb563"]

[sub_resource type="GDScript" id="GDScript_7dm0k"]
script/source = "extends Label


func _process(_delta) -> void:
	if Global.session.local_controller.targeting:
		text = str(Global.session.local_controller.targeting.target_text)
	elif Global.session.local_controller.hovered_object:
		text = Global.session.local_controller.hovered_object.display_name
	else:
		text = ''
		#text = '(%+d,%+d)' % [Global.local_controller.mouse_coords.x, Global.local_controller.mouse_coords.y]
"

[sub_resource type="StyleBoxFlat" id="StyleBoxFlat_wusub"]
bg_color = Color(0.25098, 0.25098, 0.25098, 1)

[sub_resource type="GDScript" id="GDScript_wusub"]
script/source = "extends RichTextLabel


var filter_types = []
var filter_players = []

func _add_message(content: String) -> void:
	var type = content.split('[type s=')[1].split(']')[0]
	if type in filter_types:
		return
	if content.contains('[sender]'):
		var sender = instance_from_id(int(content.split('[sender]')[1].split('[url=')[1].split(']')[0])).name
		if sender in filter_players:
			return
	newline()
	append_text(content)


func update() -> void:
	clear()
	for message in Global.session.local_controller.player.message_log:
		_add_message(message)


func _on_message_handler_filter(type: int, param: String, on: bool) -> void:
	var list_to_modify: Array
	match type:
		0:
			list_to_modify = filter_types
		1:
			list_to_modify = filter_players
	if on:
		list_to_modify.append(param)
	else:
		list_to_modify.erase(param)
	update()
"

[sub_resource type="GDScript" id="GDScript_b3bc3"]
script/source = "extends LineEdit


func _unhandled_input(event):
	if event.is_action_pressed(\"message\"):
		focus_mode = Control.FOCUS_ALL
		edit()


func _on_text_submitted(_new_text):
	clear()
	focus_mode = Control.FOCUS_NONE


func _on_editing_toggled(toggled_on):
	if !toggled_on:
		focus_mode = Control.FOCUS_NONE
"

[sub_resource type="GDScript" id="GDScript_1nbje"]
script/source = "extends MenuButton


var message_handler: MessageHandler


func setup() -> void:
	message_handler = Global.session.message_handler
	get_popup().clear()
	for i in range(message_handler.MESSAGE_TYPES.size()):
		get_popup().add_check_item(message_handler.MESSAGE_TYPES[i])
		get_popup().set_item_as_checkable(i, true)
	get_popup().id_pressed.connect(_on_id_pressed)


func _on_session_game_start() -> void:
	setup()


func _on_id_pressed(id: int) -> void:
	get_popup().set_item_checked(id, !get_popup().is_item_checked(id))
	message_handler.emit_signal('filter', 0, get_popup().get_item_text(id), get_popup().is_item_checked(id))
"

[sub_resource type="GDScript" id="GDScript_faxib"]
script/source = "extends MenuButton


var message_handler: MessageHandler


func setup() -> void:
	message_handler = Global.session.message_handler
	get_popup().clear()
	for i in range(Global.session.players.size()):
		get_popup().add_check_item(Global.session.players[i].name)
		get_popup().set_item_as_checkable(i, true)
	get_popup().id_pressed.connect(_on_id_pressed)


func _on_session_game_start() -> void:
	setup()


func _on_id_pressed(id: int) -> void:
	get_popup().set_item_checked(id, !get_popup().is_item_checked(id))
	message_handler.emit_signal('filter', 1, get_popup().get_item_text(id), get_popup().is_item_checked(id))
"

[sub_resource type="StyleBoxFlat" id="StyleBoxFlat_b3bc3"]
bg_color = Color(0.25098, 0.25098, 0.25098, 1)

[sub_resource type="GDScript" id="GDScript_yq5ji"]
script/source = "extends TabContainer


func _unhandled_input(event) -> void:
	if event.is_action_pressed(\"tab_units\"):
		current_tab = 0
	if event.is_action_pressed(\"tab_selection\"):
		current_tab = 1
	if event.is_action_pressed(\"tab_map\"):
		current_tab = 2
"

[sub_resource type="GDScript" id="GDScript_3b2b5"]
script/source = "extends Tree


func build_tree(parent_node: Group, parent_tree_item: TreeItem) -> void:
	var child = create_item(parent_tree_item)
	child.set_text(0, parent_node.display_name)
	child.set_metadata(0, parent_node)
	if parent_node.groups.size() > 0:
		for n in parent_node.groups:
			build_tree(n, child)
	else:
		for unit in parent_node.units:
			var child2 = create_item(child)
			child2.set_text(0, unit.display_name)
			child2.set_metadata(0, unit)


func check_tree(item: TreeItem, object: Node) -> void:
	if item.get_metadata(0) == object:
		item.select(0)
	else:
		item.deselect(0)
	for child in item.get_children():
		check_tree(child, object)


func update() -> void:
	clear()
	var root = create_item()
	for group in Global.session.local_controller.player.unit_groups:
		build_tree(group, root)


func _on_item_mouse_selected(mouse_position, _mouse_button_index) -> void:
	Global.session.local_controller.player.select(get_item_at_position(mouse_position).get_metadata(0))


func _on_object_selected(object: Node) -> void:
	check_tree(get_root(), object)
"

[sub_resource type="GDScript" id="GDScript_lgolh"]
script/source = "extends VBoxContainer


var connected_object: Node


func clear() -> void:
	connected_object = null
	$GridContainer/Name.text = ''
	$GridContainer/Owner.text = ''
	for child in $ScrollContainer/InspectorsGoHere.get_children():
		$ScrollContainer/InspectorsGoHere.remove_child(child)
		child.queue_free()


func _on_object_selected(object: Node) -> void:
	clear()
	if !object:
		return
	if (!object is Unit) and (!object is Group):
		return
	connected_object = object
	$GridContainer/Name.text = connected_object.display_name
	$GridContainer/Owner.text = connected_object.owning_player.name
	$GridContainer/Owner.add_theme_color_override(\"font_color\", connected_object.owning_player.color)
	
	if connected_object is Group:
		var new_inspector = load('res://Source/UI/Inspectors/GroupInspector.tscn').instantiate()
		new_inspector.linked_actor = connected_object
		$ScrollContainer/InspectorsGoHere.add_child(new_inspector)
	
	if connected_object is Unit:
		if connected_object.mover:
			var new_inspector = load('res://Source/UI/Inspectors/' + connected_object.mover.inspector + '.tscn').instantiate()
			new_inspector.linked_actor = connected_object.mover
			$ScrollContainer/InspectorsGoHere.add_child(new_inspector)
"

[sub_resource type="GDScript" id="GDScript_qrdvn"]
script/source = "extends HotkeyButton


func _pressed():
	Global.session.local_controller.target_command(CommandPlaceMarker.new())
"

[sub_resource type="GDScript" id="GDScript_fnweq"]
script/source = "extends HotkeyButton


func _pressed():
	Global.session.local_controller.target_command(CommandDrawRuler.new())
"

[sub_resource type="GDScript" id="GDScript_vrcrk"]
script/source = "extends HotkeyButton


func _pressed():
	Global.session.local_controller.show_map_ui = !Global.session.local_controller.show_map_ui
"

[sub_resource type="GDScript" id="GDScript_xb563"]
script/source = "extends Label


func _process(_delta) -> void:
	text = Global.session.game.current_time
"

[sub_resource type="GDScript" id="GDScript_fyqef"]
script/source = "extends Label


func _process(_delta) -> void:
	text = \"×\" + str(Global.session.game.time_scale)
"

[sub_resource type="GDScript" id="GDScript_m6e0p"]
script/source = "extends Label


func _process(_delta) -> void:
	visible = Global.session.game.pause
"

[sub_resource type="GDScript" id="GDScript_eqdp0"]
script/source = "extends HotkeyButton


func _pressed():
	Global.session.game.change_time_scale(0.5)
"

[sub_resource type="GDScript" id="GDScript_agc84"]
script/source = "extends HotkeyButton


func _pressed():
	Global.session.game.toggle_pause(!Global.session.game.pause)
	if Global.session.game.pause:
		text = 'Resume'
	else:
		text = 'Pause'
"

[sub_resource type="GDScript" id="GDScript_i125b"]
script/source = "extends HotkeyButton


func _pressed():
	Global.session.game.change_time_scale(2)
"

[sub_resource type="GDScript" id="GDScript_h2yge"]
script/source = "extends CenterContainer


func _unhandled_input(event) -> void:
	if event.is_action_pressed(\"toggle_menu\"):
		visible = !visible
"

[sub_resource type="GDScript" id="GDScript_0xm2m"]
script/source = "extends Button


func _pressed() -> void:
	get_tree().change_scene_to_file(\"res://Source/UI/MainMenu.tscn\")
"

[node name="UI" type="CanvasLayer"]

[node name="HSplitContainer" type="HSplitContainer" parent="."]
anchors_preset = 15
anchor_right = 1.0
anchor_bottom = 1.0
grow_horizontal = 2
grow_vertical = 2
mouse_filter = 2
theme_override_constants/separation = 0
dragging_enabled = false
dragger_visibility = 2
script = SubResource("GDScript_ywsxj")

[node name="VSplitContainer" type="VSplitContainer" parent="HSplitContainer"]
layout_mode = 2
size_flags_horizontal = 3
mouse_filter = 2
theme_override_constants/separation = 0
dragging_enabled = false
dragger_visibility = 2
script = SubResource("GDScript_f33fr")

[node name="Overlay" type="Control" parent="HSplitContainer/VSplitContainer"]
layout_mode = 2
size_flags_vertical = 3
mouse_filter = 2

[node name="SubViewportContainer" type="SubViewportContainer" parent="HSplitContainer/VSplitContainer/Overlay"]
layout_mode = 1
anchors_preset = 15
anchor_right = 1.0
anchor_bottom = 1.0
grow_horizontal = 2
grow_vertical = 2
size_flags_vertical = 3
stretch = true

[node name="SubViewport" type="SubViewport" parent="HSplitContainer/VSplitContainer/Overlay/SubViewportContainer"]
disable_3d = true
handle_input_locally = false
size = Vector2i(1560, 780)
render_target_update_mode = 4

[node name="CursorTarget" type="Label" parent="HSplitContainer/VSplitContainer/Overlay"]
layout_mode = 2
offset_right = 40.0
offset_bottom = 23.0
label_settings = SubResource("LabelSettings_xb563")
script = SubResource("GDScript_7dm0k")

[node name="BottomBar" type="PanelContainer" parent="HSplitContainer/VSplitContainer"]
custom_minimum_size = Vector2(0, 300)
layout_mode = 2
mouse_force_pass_scroll_events = false
theme_override_styles/panel = SubResource("StyleBoxFlat_wusub")

[node name="VBoxContainer" type="VBoxContainer" parent="HSplitContainer/VSplitContainer/BottomBar"]
layout_mode = 2

[node name="Messages" type="RichTextLabel" parent="HSplitContainer/VSplitContainer/BottomBar/VBoxContainer"]
layout_mode = 2
size_flags_horizontal = 3
size_flags_vertical = 3
bbcode_enabled = true
scroll_following = true
custom_effects = [ExtResource("2_ywsxj"), ExtResource("3_ywsxj"), ExtResource("4_eqdp0")]
meta_underlined = false
script = SubResource("GDScript_wusub")

[node name="LineEdit" type="LineEdit" parent="HSplitContainer/VSplitContainer/BottomBar/VBoxContainer"]
layout_mode = 2
focus_mode = 0
caret_blink = true
caret_blink_interval = 0.5
script = SubResource("GDScript_b3bc3")

[node name="HBoxContainer" type="HBoxContainer" parent="HSplitContainer/VSplitContainer/BottomBar/VBoxContainer"]
layout_mode = 2

[node name="MessageTypeFilter" type="MenuButton" parent="HSplitContainer/VSplitContainer/BottomBar/VBoxContainer/HBoxContainer"]
layout_mode = 2
size_flags_horizontal = 3
text = "Message Type Filter"
switch_on_hover = true
script = SubResource("GDScript_1nbje")

[node name="PlayerFilter" type="MenuButton" parent="HSplitContainer/VSplitContainer/BottomBar/VBoxContainer/HBoxContainer"]
layout_mode = 2
size_flags_horizontal = 3
text = "Chat Filter"
switch_on_hover = true
script = SubResource("GDScript_faxib")

[node name="Filter3" type="Button" parent="HSplitContainer/VSplitContainer/BottomBar/VBoxContainer/HBoxContainer"]
layout_mode = 2
size_flags_horizontal = 3
focus_mode = 0
text = "Other"

[node name="Filter4" type="Button" parent="HSplitContainer/VSplitContainer/BottomBar/VBoxContainer/HBoxContainer"]
layout_mode = 2
size_flags_horizontal = 3
focus_mode = 0
text = "message"

[node name="Filter5" type="Button" parent="HSplitContainer/VSplitContainer/BottomBar/VBoxContainer/HBoxContainer"]
layout_mode = 2
size_flags_horizontal = 3
focus_mode = 0
text = "filters"

[node name="Filter6" type="Button" parent="HSplitContainer/VSplitContainer/BottomBar/VBoxContainer/HBoxContainer"]
layout_mode = 2
size_flags_horizontal = 3
focus_mode = 0
text = "can"

[node name="Filter7" type="Button" parent="HSplitContainer/VSplitContainer/BottomBar/VBoxContainer/HBoxContainer"]
layout_mode = 2
size_flags_horizontal = 3
focus_mode = 0
text = "go
"

[node name="Filter8" type="Button" parent="HSplitContainer/VSplitContainer/BottomBar/VBoxContainer/HBoxContainer"]
layout_mode = 2
size_flags_horizontal = 3
focus_mode = 0
text = "here"

[node name="SideBar" type="PanelContainer" parent="HSplitContainer"]
custom_minimum_size = Vector2(360, 0)
layout_mode = 2
theme_override_styles/panel = SubResource("StyleBoxFlat_b3bc3")

[node name="VBoxContainer" type="VBoxContainer" parent="HSplitContainer/SideBar"]
layout_mode = 2

[node name="TabContainer" type="TabContainer" parent="HSplitContainer/SideBar/VBoxContainer"]
layout_mode = 2
size_flags_vertical = 3
current_tab = 1
tab_focus_mode = 0
script = SubResource("GDScript_yq5ji")

[node name="Units" type="Tree" parent="HSplitContainer/SideBar/VBoxContainer/TabContainer"]
visible = false
layout_mode = 2
focus_mode = 0
hide_root = true
script = SubResource("GDScript_3b2b5")
metadata/_tab_index = 0

[node name="Selection" type="VBoxContainer" parent="HSplitContainer/SideBar/VBoxContainer/TabContainer"]
layout_mode = 2
script = SubResource("GDScript_lgolh")
metadata/_tab_index = 1

[node name="GridContainer" type="GridContainer" parent="HSplitContainer/SideBar/VBoxContainer/TabContainer/Selection"]
layout_mode = 2
columns = 2

[node name="Name" type="Label" parent="HSplitContainer/SideBar/VBoxContainer/TabContainer/Selection/GridContainer"]
layout_mode = 2
size_flags_horizontal = 3
size_flags_vertical = 0
horizontal_alignment = 1

[node name="Owner" type="Label" parent="HSplitContainer/SideBar/VBoxContainer/TabContainer/Selection/GridContainer"]
layout_mode = 2
size_flags_horizontal = 3
size_flags_vertical = 0
horizontal_alignment = 1

[node name="ScrollContainer" type="ScrollContainer" parent="HSplitContainer/SideBar/VBoxContainer/TabContainer/Selection"]
layout_mode = 2
size_flags_vertical = 3
horizontal_scroll_mode = 0

[node name="InspectorsGoHere" type="VBoxContainer" parent="HSplitContainer/SideBar/VBoxContainer/TabContainer/Selection/ScrollContainer"]
layout_mode = 2
size_flags_horizontal = 3

[node name="Map" type="GridContainer" parent="HSplitContainer/SideBar/VBoxContainer/TabContainer"]
visible = false
layout_mode = 2
theme_override_constants/h_separation = 4
theme_override_constants/v_separation = 4
columns = 4
metadata/_tab_index = 2

[node name="MarkerButton" parent="HSplitContainer/SideBar/VBoxContainer/TabContainer/Map" instance=ExtResource("4_agc84")]
layout_mode = 2
tooltip_text = "Place Marker"
script = SubResource("GDScript_qrdvn")
command = ExtResource("5_ywsxj")

[node name="RulerButton" parent="HSplitContainer/SideBar/VBoxContainer/TabContainer/Map" instance=ExtResource("4_agc84")]
layout_mode = 2
tooltip_text = "Draw Ruler"
script = SubResource("GDScript_fnweq")
command = ExtResource("6_eqdp0")

[node name="MapUIButton" parent="HSplitContainer/SideBar/VBoxContainer/TabContainer/Map" instance=ExtResource("4_agc84")]
layout_mode = 2
tooltip_text = "Show/Hide Map UI"
script = SubResource("GDScript_vrcrk")
command = ExtResource("7_agc84")

[node name="Time" type="HBoxContainer" parent="HSplitContainer/SideBar/VBoxContainer"]
layout_mode = 2
size_flags_horizontal = 0

[node name="WorldTime" type="Label" parent="HSplitContainer/SideBar/VBoxContainer/Time"]
layout_mode = 2
text = "00:00:00"
script = SubResource("GDScript_xb563")

[node name="TimeScale" type="Label" parent="HSplitContainer/SideBar/VBoxContainer/Time"]
layout_mode = 2
text = "×1.0"
script = SubResource("GDScript_fyqef")

[node name="Pause" type="Label" parent="HSplitContainer/SideBar/VBoxContainer/Time"]
layout_mode = 2
text = "PAUSED"
script = SubResource("GDScript_m6e0p")

[node name="TimeControls" type="HBoxContainer" parent="HSplitContainer/SideBar/VBoxContainer"]
layout_mode = 2

[node name="SlowTimeButton" type="Button" parent="HSplitContainer/SideBar/VBoxContainer/TimeControls"]
layout_mode = 2
size_flags_horizontal = 3
focus_mode = 0
text = "-"
script = SubResource("GDScript_eqdp0")

[node name="PauseButton" type="Button" parent="HSplitContainer/SideBar/VBoxContainer/TimeControls"]
layout_mode = 2
size_flags_horizontal = 3
focus_mode = 0
toggle_mode = true
text = "Pause"
script = SubResource("GDScript_agc84")

[node name="SpeedTimeButton" type="Button" parent="HSplitContainer/SideBar/VBoxContainer/TimeControls"]
layout_mode = 2
size_flags_horizontal = 3
focus_mode = 0
text = "+"
script = SubResource("GDScript_i125b")

[node name="Menu" type="CenterContainer" parent="."]
visible = false
anchors_preset = 15
anchor_right = 1.0
anchor_bottom = 1.0
grow_horizontal = 2
grow_vertical = 2
mouse_filter = 0
script = SubResource("GDScript_h2yge")

[node name="VBoxContainer" type="VBoxContainer" parent="Menu"]
custom_minimum_size = Vector2(200, 100)
layout_mode = 2

[node name="ResumeButton" type="Button" parent="Menu/VBoxContainer"]
custom_minimum_size = Vector2(200, 50)
layout_mode = 2
size_flags_vertical = 3
focus_mode = 0
text = "Resume"

[node name="OptionsButton" type="Button" parent="Menu/VBoxContainer"]
custom_minimum_size = Vector2(200, 50)
layout_mode = 2
focus_mode = 0
text = "Options"

[node name="SaveButton" type="Button" parent="Menu/VBoxContainer"]
custom_minimum_size = Vector2(200, 50)
layout_mode = 2
focus_mode = 0
disabled = true
text = "Save"

[node name="QuitButton" type="Button" parent="Menu/VBoxContainer"]
custom_minimum_size = Vector2(200, 50)
layout_mode = 2
size_flags_vertical = 3
focus_mode = 0
text = "Quit"
script = SubResource("GDScript_0xm2m")

[node name="OptionsMenu" parent="Menu" instance=ExtResource("2_ff03q")]
visible = false
layout_mode = 2

[connection signal="editing_toggled" from="HSplitContainer/VSplitContainer/BottomBar/VBoxContainer/LineEdit" to="HSplitContainer/VSplitContainer/BottomBar/VBoxContainer/LineEdit" method="_on_editing_toggled"]
[connection signal="text_submitted" from="HSplitContainer/VSplitContainer/BottomBar/VBoxContainer/LineEdit" to="HSplitContainer/VSplitContainer/BottomBar/VBoxContainer/LineEdit" method="_on_text_submitted"]
[connection signal="item_mouse_selected" from="HSplitContainer/SideBar/VBoxContainer/TabContainer/Units" to="HSplitContainer/SideBar/VBoxContainer/TabContainer/Units" method="_on_item_mouse_selected"]
[connection signal="pressed" from="Menu/VBoxContainer/ResumeButton" to="Menu" method="set_visible" binds= [false]]
[connection signal="pressed" from="Menu/VBoxContainer/OptionsButton" to="Menu/VBoxContainer" method="set_visible" binds= [false]]
[connection signal="pressed" from="Menu/VBoxContainer/OptionsButton" to="Menu/OptionsMenu" method="set_visible" binds= [true]]
[connection signal="pressed" from="Menu/OptionsMenu/HBoxContainer/Back" to="Menu/VBoxContainer" method="set_visible" binds= [true]]

[editable path="HSplitContainer/SideBar/VBoxContainer/TabContainer/Map/MarkerButton"]
[editable path="Menu/OptionsMenu"]
